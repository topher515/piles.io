(function() {
  var db;
  db = require('piles.io/db');
  exports.doLogin = function(req, user, piles) {
    req.session.authenticated = {
      user: user
    };
    if (piles) {
      return req.session.authenticated.piles = piles;
    } else {
      return db.collection('piles', function(piles) {
        return (piles.find({
          emails: user.email
        })).toArray(function(err, piles) {
          return req.session.authenticated.piles = piles;
        });
      });
    }
  };
  exports.authData = function(req) {
    return req.session.authenticated || null;
  };
}).call(this);
