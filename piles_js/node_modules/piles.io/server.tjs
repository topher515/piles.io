var tamejs = require('tamejs').register()
,   db = require('piles.io/db.tjs')
;

exports.register = function(app) {

app.get('/login', function(req, res) {
    res.render('login', {email:'Email'});
})

app.post('/login', function(req, res) {
    if (!req.body.email || !req.body.password)
        return res.render('login',{email:req.body.email,errors:['No username or password']});
    
    var hashed_pwd = utils.hashPassword(req.body.password),
        email = req.body.email.toLowerCase();
         
    var err,user; await {
        db.collection('users').findOne({email:email,password:password}, defer(err,user));
    }

    if (!user) 
        return res.render('login',{email:email,errors:['Bad email or password.']});

    var userPiles; await {
        db.collection('piles').find({emails:email},defer(err,userPiles));
    }

    auth.doLogin(req, user, userPiles);

    if (userPiles) {
        return res.redirect('/'+piles[0]['name']);
    } else {
        return res.redirect('/broke');
    }

})

app.get('/:pilename', function(req,res) {
    
    var pile; await { 
        db.collection('piles').findOne({name:req.params.pilename},defer(err,pile));
    }
    if (err && !pile) {
        return res.send(404);
    }
    return res.redirect('/app#'+req.params.pilesame);
    
});

};