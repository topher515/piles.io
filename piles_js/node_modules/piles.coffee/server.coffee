sys         = require 'sys'
db          = (require 'piles.io/db')
utils       = require 'piles.io/utils'
settings    = (require 'piles.io/settings').settings
auth        = require 'piles.io/auth'
        

exports.register = (app) ->
    
    app.get '/login', (req, res) ->
        res.render 'login', {email:'Email'}
        
        
    app.post '/login', (req, res) ->
        if not req.body.email or not req.body.password
            return res.render 'login', {email:req.body.email, errors:['No username or password']}
        
        hashedPwd = utils.hashPassword req.body.password
        email = req.body.email.toLowerCase()
        
        db.collection 'users', (users) ->
            users.findOne {email:email, password:hashedPwd}, (err, user) ->
                if not user
                    return res.render 'login', {email:email, errors:['Bad email or password']}

                auth.doLogin req, user
                
                db.collection 'piles', (piles) ->
                    (piles.find {emails:email}).toArray (err, userPiles) ->
                        if userPiles
                            return res.redirect '/'+userPiles[0]['name']
                        else
                            res.redirect '/broke'

        

                        
    app.get '/:pilename', (req, res) ->
        db.collection 'piles', (piles) ->
            piles.findOne {name:req.params.pilename}, (err,pile) ->
                if pile
                    res.redirect 'http://' + settings.CONTENT_DOMAIN + '/app#' +req.params.pilename
                else
                    res.send(404)