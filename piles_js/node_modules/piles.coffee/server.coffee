sys         = require 'sys'
db          = (require 'piles.io/db')
utils       = require 'piles.io/utils'
settings    = (require 'piles.io/settings').settings
auth        = require 'piles.io/auth'
        

exports.register = (app) ->
    
    ###
    ## Middleware
    ###
    
    enableCors = (req,res,next)->
        res.header 'Access-Control-Allow-Origin', 'http://'+settings.CONTENT_DOMAIN
        next()
    
    ###
    ## API
    ###
    
    app.get '/piles', enableCors, (req, res)->
        if not req.query.name
            return res.json([])
        db.collection 'piles', (piles)->
            piles.find({name:req.query.name}).toArray (err, piles)->
                return res.json(piles)
        
    
    ###
    ## Pages
    ###
    
    app.get '/login', (req, res) ->
        res.render 'login', {email:'Email'}
        
        
    app.post '/login', (req, res) ->
        if not req.body.email or not req.body.password
            return res.render 'login', {email:req.body.email, errors:['No username or password']}
        
        hashedPwd = utils.hashPassword req.body.password
        email = req.body.email.toLowerCase()
        
        db.collection 'users', (users) ->
            users.findOne {email:email, password:hashedPwd}, (err, user) ->
                if not user
                    return res.render 'login', {email:email, errors:['Bad email or password']}

                auth.doLogin req, user
                
                db.collection 'piles', (piles) ->
                    (piles.find {emails:email}).toArray (err, userPiles) ->
                        if userPiles
                            return res.redirect '/'+userPiles[0]['name']
                        else
                            res.redirect '/broke'

        


    app.get '/', (req, res)->
        authData = auth.authData(req)
        if auth.authData(req)
            return res.redirect '/'+authData.piles[0]['name']
        else
            return res.redirect '/login'
    
                        
    app.get '/:pilename', (req, res) ->
        db.collection 'piles', (piles) ->
            piles.findOne {name:req.params.pilename}, (err,pile) ->
                if pile
                    res.redirect 'http://' + settings.CONTENT_DOMAIN + '/app#' +req.params.pilename
                else
                    res.send(404)